<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Suche – Redminer9630</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: 'Mojangles', system-ui, sans-serif; background:#eaeaea; margin:1rem; }
    h1 { margin-bottom:1rem; }
    #search-section { display:flex; gap:.6rem; align-items:flex-start; margin-bottom:1rem; }
    #search-wrapper { flex:1; min-width:220px; position:relative; }
    #search-input {
      width:100%; padding:.5rem .6rem; font-size:1rem; box-sizing:border-box;
      border:none; outline:none; background-clip:padding-box;
    }
    #search-button { padding:.5rem 1rem; cursor:pointer; }
    #search-suggestions {
      position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:20;
      border:1px solid #ccc; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.06);
      display:none;
    }
    #search-suggestions .item { display:flex; justify-content:space-between; gap:.5rem; padding:.45rem .6rem; cursor:pointer; }
    #search-suggestions .item:hover { background:#f3f3f3; }
    #search-suggestions .remove { color:#c33; cursor:pointer; margin-left:.5rem; user-select:none; }
    #results { margin-top:1rem; }
    .no-results { color:#666; font-style:italic; }
    .result-item { padding:.6rem 0; animation: fadeInUp .28s ease both; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(6px);} to { opacity:1; transform:none; } }
    hr { border:none; border-top:1px solid #e0e0e0; margin:.5rem 0; }
    :root[data-theme="dark"] body { background:#101010; color:#eee; }
    :root[data-theme="dark"] #search-suggestions { background:#111; border:1px solid #333; color:#eee; }
    :root[data-theme="dark"] #search-suggestions .item:hover { background:#1a1a1a; }
  </style>
  <script type="module" defer src="https://cdn.jsdelivr.net/gh/Redminer9630/Website@t55/docs/autoloader.js"></script>
</head>
<body>
  <h1>Suche</h1>

  <section id="search-section">
    <div id="search-wrapper">
      <input id="search-input" type="search" autocomplete="off" placeholder="Suchbegriff eingeben" />
      <div id="search-suggestions" aria-label="Suchvorschläge"></div>
    </div>
    <button id="search-button">Suchen</button>
  </section>

  <div id="results"></div>

  <script>
    const JSON_FILES = [
      "search/index.json",
      "search/discord.json",
      "search/news.json",
      "search/projects.json",
      "search/linktree.json",
      "search/manual.json"
    ];
    const SEARCH_KEY = "searchHistory";
    const MAX_HISTORY = 15;
    const SUGGEST_SHOW = 4;

    const input = document.getElementById("search-input");
    const searchBtn = document.getElementById("search-button");
    const suggestions = document.getElementById("search-suggestions");
    const results = document.getElementById("results");

    const normalize = txt => (txt||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

    function getHistory(){ try { return JSON.parse(localStorage.getItem(SEARCH_KEY) || "[]"); } catch { return []; } }
    function setHistory(arr){ localStorage.setItem(SEARCH_KEY, JSON.stringify(arr)); }
    function saveHistory(term){
      if(!term) return;
      let arr = getHistory().filter(t=>t!==term);
      arr.unshift(term);
      if(arr.length > MAX_HISTORY) arr = arr.slice(0, MAX_HISTORY);
      setHistory(arr);
    }
    function deleteHistoryTerm(term){
      const arr = getHistory().filter(t=>t!==term);
      setHistory(arr);
      renderSuggestions(false);
    }

    let suggestionsVisible = false;
    function renderSuggestions(show = true){
      suggestions.innerHTML = "";
      const arr = getHistory();
      if(!show || arr.length === 0){ suggestions.style.display = "none"; suggestionsVisible = false; return; }
      const toShow = arr.slice(0, SUGGEST_SHOW);
      toShow.forEach(term => {
        const row = document.createElement("div");
        row.className = "item";
        const txt = document.createElement("span");
        txt.textContent = term;
        txt.style.flex = "1";
        txt.addEventListener("mousedown", (e) => {
          e.preventDefault();
          input.value = term;
          doSearch();
        });
        const rem = document.createElement("span");
        rem.className = "remove";
        rem.textContent = "×";
        rem.title = "Löschen";
        rem.addEventListener("mousedown", (e) => { e.preventDefault(); e.stopPropagation(); deleteHistoryTerm(term); });

        row.appendChild(txt);
        row.appendChild(rem);
        suggestions.appendChild(row);
      });
      suggestions.style.display = "block";
      suggestionsVisible = true;
    }

    input.addEventListener("focus", ()=> renderSuggestions(true));
    input.addEventListener("blur", ()=> { setTimeout(()=>{ renderSuggestions(false); }, 120); });

    input.addEventListener("input", ()=> { if(suggestionsVisible) renderSuggestions(true); });

    async function loadAllData(){
      const data = [];
      for(const file of JSON_FILES){
        try{
          const r = await fetch(file, {cache: "no-store"});
          if(!r.ok) { console.warn("JSON nicht gefunden:", file, r.status); continue; }
          const j = await r.json();
          if(Array.isArray(j)) data.push(...j);
          else console.warn("JSON hat kein Array:", file);
        } catch(err){
          console.warn("Fehler beim Laden", file, err);
        }
      }
      return data;
    }

    async function runSearch(term){
      results.innerHTML = ""; // immer neu leeren
      if(!term) return;

      let allData = [];
      try {
        allData = await loadAllData();
      } catch(e) {
        console.error("Fehler beim Laden aller Daten:", e);
      }

      if(allData.length === 0){
        results.innerHTML = `<div class="no-results">Keine Index-Daten geladen. Prüfe die JSON-Dateien im /search-Ordner.</div>`;
        return;
      }

      const q = normalize(term);
      const words = q.split(" ").filter(Boolean);

      const found = allData.filter(entry => {
        const text = [entry.title||"", entry.desc||"", ...(entry.alias||[])].join(" ");
        const flat = normalize(text);
        // require all words to appear (AND-search)
        return words.every(w => flat.includes(w));
      });

      if(found.length === 0){
        results.innerHTML = `<div class="no-results">Keine Ergebnisse gefunden für: <strong>${escapeHtml(term)}</strong></div>`;
        return;
      }

      const h2 = document.createElement("h2");
      h2.textContent = "Ergebnisse";
      results.appendChild(h2);

      found.forEach((e,i) => {
        const item = document.createElement("div");
        item.className = "result-item";

        const title = document.createElement("div");
        const a = document.createElement("a");
        a.textContent = e.title || "Ohne Titel";
        a.href = e.url || "#";
        if(a.href.startsWith("http") && !a.href.includes(location.hostname)){
          a.target = "_blank"; a.rel = "noopener";
        }
        title.appendChild(a);
        title.style.fontWeight = "700";

        const desc = document.createElement("div");
        desc.innerHTML = `<small>${e.desc || ""}</small>`;

        item.appendChild(title);
        item.appendChild(desc);
        results.appendChild(item);

        if(i < found.length - 1) results.appendChild(document.createElement("hr"));
      });
    }

    function doSearch(){
      const term = input.value.trim();
      if(!term){
        results.innerHTML = "";
        if(location.search) history.replaceState(null, "", location.pathname);
        return;
      }
      const newQ = "?q=" + encodeURIComponent(term);
      if(location.search !== newQ) history.replaceState(null, "", newQ);

      runSearch(term);
      saveHistory(term);
      renderSuggestions(false);
    }

    searchBtn.addEventListener("click", doSearch);
    input.addEventListener("keydown", (e) => { if(e.key === "Enter"){ e.preventDefault(); doSearch(); } });

    window.addEventListener("popstate", () => {
      const q = new URLSearchParams(location.search).get("q") || "";
      input.value = q;
      if(q) runSearch(q); else results.innerHTML = "";
    });

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[m]));
    }

    (function init(){
      const q = new URLSearchParams(location.search).get("q") || "";
      if(q){
        input.value = q;
        runSearch(q);
      }
      renderSuggestions(false);
    })();
  </script>
</body>
</html>
