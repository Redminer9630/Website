<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Suche – Redminer9630</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body { font-family: 'Mojangles', system-ui, sans-serif; background: #eaeaea; margin: 1rem; }
    h1 { margin-bottom: 1rem; }
    #search-section { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }

    /* Wrapper für Input + Clear + Suggestions */
    #search-wrapper { flex: 1; min-width: 220px; position: relative; }
    #search-input {
      width: 100%;
      padding: 0.5rem 2rem 0.5rem 0.5rem; /* Platz rechts fürs X */
      font-size: 1rem;
      font-family: 'Mojangles', system-ui, sans-serif;
      box-sizing: border-box;
    }
    #clear-btn {
      position: absolute;
      right: .4rem;
      top: 50%;
      transform: translateY(-50%);
      border: none; background: transparent;
      font-size: 1.1rem; line-height: 1;
      cursor: pointer; display: none; user-select: none;
    }
    #clear-btn:hover { color: red; }

    button {
      background: #eaeaea; color: black;
      padding: 10px 20px; border: none; cursor: pointer;
      font-family: 'Mojangles', system-ui, sans-serif; font-size: 1rem;
    }
    button:hover { background: #cacaca; }

    #results { margin-top: 1rem; }
    .no-results { color: #888; font-style: italic; margin-top: 1rem; }

    .result-item { opacity: 0; transform: translateY(10px); animation: fadeInUp 0.4s ease forwards; }
    @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }

    /* Suggestions-Dropdown */
    #search-suggestions {
      position: absolute; top: calc(100% + 4px); left: 0; right: 0;
      border: 1px solid #ccc; background: #fff; z-index: 10;
    }
    #search-suggestions .item {
      display: flex; justify-content: space-between; align-items: center;
      padding: .35rem .55rem; cursor: pointer; gap: .5rem;
    }
    #search-suggestions .item:hover { background: #eee; }
    #search-suggestions .remove { cursor: pointer; color: red; font-weight: bold; user-select: none; }

    /* Dark Mode */
    :root[data-theme="dark"] body { background: #1a1a1a; color: #eee; }
    :root[data-theme="dark"] #search-input { background: #222; color: #eee; border: 1px solid #444; }
    :root[data-theme="dark"] button { background: #1a1a1a; color: white; }
    :root[data-theme="dark"] button:hover { background: #3a3a3a; }
    :root[data-theme="dark"] #results { color: #ccc; }
    :root[data-theme="dark"] .no-results { color: #666; }
    :root[data-theme="dark"] #search-suggestions { background:#222; border:1px solid #444; color:#eee; }
    :root[data-theme="dark"] #search-suggestions .item:hover { background:#333; }
    :root[data-theme="dark"] #search-suggestions .remove { color:#f66; }

    #search-input::-webkit-search-decoration { -webkit-appearance: searchfield-decoration; }
    :root[data-theme="dark"] #search-input::-webkit-search-decoration { filter: invert(1) brightness(1.5); }
  </style>

  <!-- Falls du globale Styles/JS brauchst, lass autoloader drin -->
  <script src="https://cdn.jsdelivr.net/gh/Redminer9630/Website@t48/docs/autoloader.js" type="module" defer></script>
</head>
<body>
  <h1>Suche</h1>

  <section id="search-section">
    <div id="search-wrapper">
      <input id="search-input" type="search" aria-label="Suche..." placeholder="Suchbegriff eingeben" />
      <button id="clear-btn" aria-label="Suche leeren" title="Suche leeren">×</button>
      <div id="search-suggestions" aria-label="Suchvorschläge"></div>
    </div>
    <button id="search-button">Suchen</button>
  </section>

  <div id="results"></div>

  <script>
    // === Elemente ===
    const input        = document.getElementById("search-input");
    const results      = document.getElementById("results");
    const suggestions  = document.getElementById("search-suggestions");
    const clearBtn     = document.getElementById("clear-btn");
    const searchBtn    = document.getElementById("search-button");

    // === URL-Query übernehmen (von Mainpage) ===
    (function initFromURL(){
      const urlParams = new URLSearchParams(location.search);
      const q = urlParams.get("q");
      if (q) {
        input.value = q;
        updateClearBtn();
        runSearch(q);
        saveHistory(q); // auch speichern, wenn man von extern kommt
      }
    })();

    // === Suchen per Button ===
    searchBtn.addEventListener("click", () => {
      const term = input.value.trim();
      if (term) {
        history.replaceState(null, "", "?q=" + encodeURIComponent(term));
        runSearch(term);
        saveHistory(term);
      }
    });

    // === Suchen per Enter (keypress ist deprecated) ===
    input.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchBtn.click();
      }
    });

    // === Clear-Button im Input ===
    function updateClearBtn() {
      clearBtn.style.display = input.value ? "block" : "none";
    }
    input.addEventListener("input", () => {
      updateClearBtn();
      renderSuggestions(true); // beim Tippen Vorschläge aktualisieren
    });
    clearBtn.addEventListener("click", () => {
      const last = input.value.trim();
      if (last) saveHistory(last);   // vorher speichern
      input.value = "";
      results.innerHTML = "";
      updateClearBtn();
      input.focus();
      renderSuggestions(true);
    });

    // === Daten laden & durchsuchen ===
    async function runSearch(term) {
      results.innerHTML = "";

      const jsonFiles = [
        "search/index.json",
        "search/discord.json",
        "search/news.json",
        "search/projects.json",
        "search/linktree.json",
        "search/manual.json"
      ];

      let data = [];
      try {
        const fetches = jsonFiles.map(file =>
          fetch(file).then(res => res.json()).catch(() => [])
        );
        const arrays = await Promise.all(fetches);
        arrays.forEach(arr => { if (Array.isArray(arr)) data.push(...arr); });
      } catch (e) {
        console.error("Fehler beim Laden der JSON-Dateien:", e);
      }

      const normalized = txt => (txt || "")
        .toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
        .replace(/[^a-z0-9äöüß ]/gi, "");

      const words = normalized(term).split(" ").filter(Boolean);
      const found = data.filter(e => {
        const combined = [e.title, e.desc, ...(e.alias || [])].join(" ");
        const flat = normalized(combined);
        return words.some(w => flat.includes(w));
      });

      if (found.length > 0) {
        const h2 = document.createElement("h2");
        h2.textContent = "Ergebnisse";
        results.appendChild(h2);

        found.forEach((e, i) => {
          const div = document.createElement("div");
          div.classList.add("result-item");
          div.style.animationDelay = `${i * 0.05}s`;

          const url = e.url || "#";
          const isExternal = url.startsWith("http") && !url.includes(location.hostname);
          const anchorOpen = isExternal
            ? `<a href="${url}" onclick="if(window.leaveSite){leaveSite(event, this)}"${e.safe ? ' safe' : ''}>`
            : `<a href="${url}">`;

          div.innerHTML = `<strong>${anchorOpen}${e.title}</a></strong><br><small>${e.desc || ""}</small><hr>`;
          results.appendChild(div);

          if (typeof e.special_feature === "function") {
            try { e.special_feature(); } catch { /* ignore */ }
          }
        });
      } else {
        results.innerHTML = `<div class="no-results">Keine Ergebnisse gefunden für: <strong>${term}</strong></div>`;
      }

      results.innerHTML += "<br><br><br>";
    }

    // === History & Suggestions ===
    const SEARCH_KEY  = "searchHistory";
    const maxStored   = 15;
    const defaultShow = 4;

    function getHistory(){ return JSON.parse(localStorage.getItem(SEARCH_KEY) || "[]"); }
    function setHistory(a){ localStorage.setItem(SEARCH_KEY, JSON.stringify(a)); }
    function saveHistory(term){
      if (!term) return;
      let arr = getHistory().filter(t => t !== term);
      arr.push(term);
      if (arr.length > maxStored) arr = arr.slice(arr.length - maxStored);
      setHistory(arr);
    }
    function deleteHistory(term){
      setHistory(getHistory().filter(t => t !== term));
      renderSuggestions(true);
    }

    let hasFocus = false;

    function renderSuggestions(focus=false){
      suggestions.innerHTML = "";
      if (!focus || !hasFocus) return;

      const arr = getHistory();
      if (!arr.length) return;

      const show = arr.slice(-defaultShow).reverse();
      show.forEach(term => {
        const row = document.createElement("div");
        row.className = "item";

        const text = document.createElement("span");
        text.textContent = term;
        text.style.flex = "1";
        text.addEventListener("mousedown", e => { // mousedown: kein Blur
          e.preventDefault();
          input.value = term;
          updateClearBtn();
          searchBtn.click();
        });

        const remove = document.createElement("span");
        remove.textContent = "×";
        remove.className = "remove";
        remove.addEventListener("mousedown", (e) => {
          e.preventDefault(); e.stopPropagation();
          deleteHistory(term);
        });

        row.appendChild(text);
        row.appendChild(remove);
        suggestions.appendChild(row);
      });
    }

    input.addEventListener("focus", () => { hasFocus = true;  renderSuggestions(true); });
    input.addEventListener("blur",  () => { hasFocus = false; setTimeout(() => { suggestions.innerHTML = ""; }, 100); });
    input.addEventListener("input", () => { renderSuggestions(true); });
  </script>
</body>
</html>
