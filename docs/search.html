<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Suche – Redminer9630</title>
  <style>
    body { font-family: 'Mojangles'; background: #eaeaea; margin: 1rem; }
    h1 { margin-bottom: 1rem; }
    #search-section { display: flex; flex-wrap: wrap; gap: 0.4rem; margin-bottom: 1rem; }
    #search-wrapper { flex: 1; position: relative; }
    #search-input {
      width: 100%;
      padding: 0.5rem;
      font-size: 1rem;
      font-family: 'Mojangles';
      box-sizing: border-box;
    }
    button {
      background: #eaeaea;
      color: black;
      padding: 10px 20px;
      border: none;
      cursor: pointer;
      font-family: 'Mojangles';
      font-size: 1rem;
    }
    button:hover { background: #cacaca; }
    #results { margin-top: 1rem; }
    .no-results { color: #888; font-style: italic; margin-top: 1rem; }

    .result-item {
      opacity: 0;
      transform: translateY(10px);
      animation: fadeInUp 0.4s ease forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: translateY(0); }
    }

    /* Suggestions */
    #search-suggestions {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      border: 1px solid #ccc;
      background: #fff;
      z-index: 10;
    }
    #search-suggestions div {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.3rem 0.5rem;
      cursor: pointer;
    }
    #search-suggestions div:hover { background: #eee; }
    #search-suggestions span.remove {
      cursor: pointer;
      margin-left: 0.5rem;
      color: red;
      font-weight: bold;
    }

    /* Dark Mode */
    :root[data-theme="dark"] body { background: #1a1a1a; color: #eee; }
    :root[data-theme="dark"] #search-input {background: #222;color: #eee;border: 1px solid #444;}
    :root[data-theme="dark"] button { background: #1a1a1a; color: white; }
    :root[data-theme="dark"] button:hover { background: #3a3a3a; }
    :root[data-theme="dark"] #results { color: #ccc; }
    :root[data-theme="dark"] .no-results { color: #666; }
    :root[data-theme="dark"] #search-suggestions { background:#222; border:1px solid #444; color:#eee; }
    :root[data-theme="dark"] #search-suggestions div:hover { background:#333; }
    :root[data-theme="dark"] #search-suggestions span.remove { color:#f66; }

    #search-input::-webkit-search-decoration {
      -webkit-appearance: searchfield-decoration;
    }
    :root[data-theme="dark"] #search-input::-webkit-search-decoration {
      filter: invert(1) brightness(1.5);
    }
  </style>
  <script src="https://cdn.jsdelivr.net/gh/Redminer9630/Website@t45/docs/autoloader.js" type="module" defer></script>
</head>
<body>
  <h1>Suche</h1>
  <section id="search-section">
    <div id="search-wrapper">
      <input id="search-input" type="search" aria-label="Suche..." placeholder="Suchbegriff eingeben" />
      <div id="search-suggestions"></div>
    </div>
    <button id="search-button">Suchen</button>
  </section>
  <div id="results"></div>

  <script>
    const input = document.getElementById("search-input");
    const results = document.getElementById("results");
    const suggestions = document.getElementById("search-suggestions");

    const urlParams = new URLSearchParams(location.search);
    const q = urlParams.get("q");
    if(q){
      input.value = q;
      runSearch(q);
    }

    document.getElementById("search-button").addEventListener("click",()=>{
      const term = input.value.trim();
      if(term){
        history.replaceState(null,"","?q="+encodeURIComponent(term));
        runSearch(term);
        saveHistory(term);
      }
    });

    input.addEventListener("keypress",e=>{
      if(e.key==="Enter"){
        e.preventDefault();
        document.getElementById("search-button").click();
      }
    });

    async function runSearch(term){
      results.innerHTML = "";

      const jsonFiles = [
        "search/index.json",
        "search/discord.json",
        "search/news.json",
        "search/projects.json",
        "search/linktree.json",
        "search/manual.json"
      ];

      let data = [];
      try {
        const fetches = jsonFiles.map(file =>
          fetch(file)
            .then(res=>res.json())
            .catch(e=>{ console.warn(`Fehler beim Laden von ${file}:`, e); return []; })
        );
        const resultsArrays = await Promise.all(fetches);
        resultsArrays.forEach(arr => { if(Array.isArray(arr)) data.push(...arr) });
      } catch(e){
        console.error("Fehler beim Laden der JSON-Dateien:", e);
      }

      const normalized = txt => txt.toLowerCase()
        .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
        .replace(/[^a-z0-9äöüß ]/gi,"");

      const words = normalized(term).split(" ").filter(w=>w);
      const found = data.filter(e=>{
        const combined = [e.title, e.desc, ...(e.alias||[])].join(" ");
        const flat = normalized(combined);
        return words.some(w => flat.includes(w));
      });

      if(found.length > 0){
        const h2 = document.createElement("h2");
        h2.textContent = "Ergebnisse";
        results.appendChild(h2);

        found.forEach((e,i)=>{
          const div = document.createElement("div");
          div.classList.add("result-item");
          div.style.animationDelay = `${i*0.05}s`;

          if(!e.url) e.url = "#";

          const isExternal = e.url.startsWith("http") && !e.url.includes(location.hostname);
          if(isExternal){
            div.innerHTML = `<strong><a href="${e.url}" onclick="leaveSite(event, this)"${e.safe ? ' safe' : ''}>${e.title}</a></strong><br><small>${e.desc}</small><hr>`;
          } else {
            div.innerHTML = `<strong><a href="${e.url}">${e.title}</a></strong><br><small>${e.desc}</small><hr>`;
          }
          results.appendChild(div);

          if(typeof e.special_feature === "function"){ e.special_feature() }
        });
      } else {
        results.innerHTML = `<div class="no-results">Keine Ergebnisse gefunden für: <strong>${term}</strong></div>`;
      }
      results.innerHTML += "<br><br><br>";
    }

    // Such Empfehlungen & Query Speicherung
    const SEARCH_KEY = "searchHistory";
    const maxStored = 15;
    const defaultShow = 4;

    function getHistory(){ 
      return JSON.parse(localStorage.getItem(SEARCH_KEY) || "[]"); 
    }

    function saveHistory(term){
      if(!term) return;
      let arr = getHistory();
      arr = arr.filter(t => t !== term);
      arr.push(term);
      if(arr.length > maxStored) arr = arr.slice(arr.length - maxStored);
      localStorage.setItem(SEARCH_KEY, JSON.stringify(arr));
    }

    function deleteHistory(term){
      let arr = getHistory().filter(t => t !== term);
      localStorage.setItem(SEARCH_KEY, JSON.stringify(arr));
      renderSuggestions(true);
    }

    function renderSuggestions(focus=false){
      suggestions.innerHTML = "";
      if(!focus) return; // nur anzeigen, wenn Input Fokus hat

      let arr = getHistory();
      if(!arr.length) return;

      let show = arr.slice(-defaultShow).reverse();
      show.forEach(term=>{
        const div = document.createElement("div");

        const text = document.createElement("span");
        text.textContent = term;
        text.style.flex = "1";

        text.addEventListener("click",()=>{ 
          input.value = term; 
          document.getElementById("search-button").click(); 
        });

const remove = document.createElement("span");
remove.textContent = "×";
remove.classList.add("remove");
remove.addEventListener("mousedown",(e)=>{
  e.preventDefault();
  e.stopPropagation();
  deleteHistory(term);
});

        div.appendChild(text);
        div.appendChild(remove);
        suggestions.appendChild(div);
      });
    }

    input.addEventListener("focus",()=>{ renderSuggestions(true); });
    input.addEventListener("blur",()=>{ setTimeout(()=>{ suggestions.innerHTML=""; }, 100); });
    input.addEventListener("input",()=>{ renderSuggestions(true); });
  </script>
</body>
</html>
