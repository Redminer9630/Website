<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Suche – Redminer9630</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family:Mojangles; background:#eaeaea; margin:1rem; color:#000; }
    h1 { margin-bottom:1rem; }
    #search-section { display:flex; gap:.6rem; align-items:stretch; margin-bottom:1rem; }
    #search-wrapper { flex:1; min-width:220px; position:relative; }
    #search-input {
      width:100%; padding:.5rem .6rem; font-size:1rem; box-sizing:border-box;
      border:1px solid transparent; border-radius:6px; outline:none; background-clip:padding-box; height:44px;
      background:#fff; color:#000;
    }
#search-suggestions {
  position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:20;
  border:1px solid #ccc; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.06);
  border-radius:4px; padding:0; display:none;
  max-height:176px;
  overflow-y:auto;
}
#search-suggestions .item {
  display:flex; justify-content:space-between; gap:.5rem;
  padding:0 .6rem; cursor:pointer; align-items:center;
  font-size:1rem; height:44px; line-height:44px;
}
    #search-button {
      font-family: inherit;
      font-size: 16px;
      background-color: #1a1a1a;
      color: #fff;
      padding: 0 20px;
      border-radius:6px;
      border: 1px solid #eaeaea;
      cursor: pointer;
      height:44px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      line-height:1;
    }
    #search-button:hover { opacity:.95; }
    #results { margin-top:1rem; }
    .no-results { color:#666; font-style:italic; }
    .result-item { padding:.6rem 0; animation: fadeInUp .24s ease both; }
    .result-sep { border:none; border-top:1px solid #e0e0e0; margin:.5rem 0; animation: fadeInUp .24s ease both; }
    @keyframes fadeInUp { from { opacity:0; transform:translateY(6px);} to { opacity:1; transform:none; } }
    mark { background:#fffb91; color:inherit; padding:0; box-decoration-break:clone; }
    #search-suggestions {
      position:absolute; top:calc(100% + 6px); left:0; right:0; z-index:20;
      border:1px solid #ccc; background:#fff; box-shadow:0 6px 18px rgba(0,0,0,.06);
      border-radius:6px; padding:4px 0; display:none;
    }
    #search-suggestions .item {
      display:flex; justify-content:space-between; gap:.5rem; padding:.45rem .6rem; cursor:pointer; align-items:center;
    }
    #search-suggestions .item:hover { background:#f3f3f3; }
    #search-suggestions .remove {
      color:#c33; cursor:pointer; margin-left:.5rem; user-select:none; display:inline-flex; align-items:center; height:20px;
      font-weight:700; line-height:1; transform: translateY(-1px);
    }
    :root[data-theme="dark"] body { background:#101010; color:#eee; }
    :root[data-theme="dark"] #search-input { background:#111; color:#eee; border-color:#333; }
    :root[data-theme="dark"] #search-suggestions { background:#111; border:1px solid #333; color:#eee; box-shadow:none; }
    :root[data-theme="dark"] #search-suggestions .item:hover { background:#1a1a1a; }
    :root[data-theme="dark"] mark { background:#5a5a1e; }
  </style>
  <script type="module" defer src="https://cdn.jsdelivr.net/gh/Redminer9630/Website@t69/docs/autoloader.js"></script>
</head>
<body>
  <h1>Suche</h1>

  <section id="search-section">
    <div id="search-wrapper">
      <input id="search-input" type="search" autocomplete="off" placeholder="Suchbegriff eingeben" />
      <div id="search-suggestions" aria-label="Suchvorschläge"></div>
    </div>
    <button id="search-button">Suchen</button>
  </section>

  <div id="results"></div>

<script>
  const JSON_FILES = [
    "search/index.json",
    "search/discord.json",
    "search/news.json",
    "search/projects.json",
    "search/linktree.json",
    "search/manual.json"
  ];
  const SETTINGS_KEY = "searchMaxHistory";
  let MAX_HISTORY = parseInt(localStorage.getItem(SETTINGS_KEY) || "15", 10);
  const SEARCH_KEY = "searchHistory";
  const SUGGEST_SHOW = 4;

  const input = document.getElementById("search-input");
  const searchBtn = document.getElementById("search-button");
  const suggestions = document.getElementById("search-suggestions");
  const results = document.getElementById("results");
  const searchWrapper = document.getElementById("search-wrapper");

  const normalize = t => (t||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");

  function isValidQuery(q){return q && q.trim().length > 0;}
  function getHistory(){ try { return JSON.parse(localStorage.getItem(SEARCH_KEY) || "[]"); } catch { return []; } }
  function setHistory(arr){ localStorage.setItem(SEARCH_KEY, JSON.stringify(arr)); }
  function saveHistory(term){
    if(!term) return;
    let arr = getHistory().filter(t=>t!==term);
    arr.unshift(term);
    if(arr.length > MAX_HISTORY) arr = arr.slice(0, MAX_HISTORY);
    setHistory(arr);
  }
  function deleteHistoryTerm(term){
    const arr = getHistory().filter(t=>t!==term);
    setHistory(arr);
    if(arr.length > 0) renderSuggestions(true); else renderSuggestions(false);
  }

  let suggestionsVisible = false;
  function renderSuggestions(show = true){
    suggestions.innerHTML = "";
    const arr = getHistory();
    if(!show || arr.length === 0){ suggestions.style.display = "none"; suggestionsVisible = false; return; }
    const toShow = arr.slice(0, SUGGEST_SHOW);
    toShow.forEach(term => {
      const row = document.createElement("div");
      row.className = "item";
      const txt = document.createElement("span");
      txt.textContent = term;
      txt.style.flex = "1";
      txt.addEventListener("mousedown", (e) => {
        e.preventDefault();
        input.value = term;
        doSearch();
      });
      const rem = document.createElement("span");
      rem.className = "remove";
      rem.textContent = "×";
      rem.title = "Löschen";
      rem.addEventListener("mousedown", (e) => { e.preventDefault(); e.stopPropagation(); deleteHistoryTerm(term); });
      row.appendChild(txt);
      row.appendChild(rem);
      suggestions.appendChild(row);
    });
    suggestions.style.display = "block";
    suggestionsVisible = true;
  }

  input.addEventListener("focus", ()=> renderSuggestions(true));
  input.addEventListener("blur", ()=> { setTimeout(()=>{ renderSuggestions(false); }, 120); });
  input.addEventListener("input", ()=> { if(suggestionsVisible) renderSuggestions(true); });
  document.addEventListener("click", (ev) => { if(!searchWrapper.contains(ev.target)) renderSuggestions(false); });

  let cacheData = null;
  async function loadAllData(){
    if (cacheData) return cacheData;
    const responses = await Promise.all(JSON_FILES.map(f => fetch(f, {cache:"no-store"}).catch(()=>null)));
    const jsons = await Promise.all(responses.map(r => r && r.ok ? r.json() : []));
    const merged = [];
    jsons.forEach(j => { if (Array.isArray(j)) merged.push(...j); });
    cacheData = merged;
    return cacheData;
  }

  function highlightHtml(html, words){
    const marks = localStorage.getItem("marks") === "true";
    if(!marks) return html;
    let out = html;
    words.forEach(w=>{
      if(!w) return;
      const rx = new RegExp(`(${w.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})`, "gi");
      out = out.replace(rx, "<mark>$1</mark>");
    });
    return out;
  }

async function runSearch(term){
  results.innerHTML = "";
  if(!isValidQuery(term)) return;
  if(!term) return;
  const start = performance.now();
  const allData = await loadAllData();
  if(allData.length === 0){
    results.innerHTML = `<div class="no-results">Keine Suchdaten verfügbar.</div>`;
    return;
  }
  const q = normalize(term);
  const words = q.split(" ").filter(Boolean);
  const found = allData.filter(entry => {
    const text = [entry.title||"", entry.desc||"", ...(entry.alias||[])].join(" ");
    const flat = normalize(text);
    return words.every(w => flat.includes(w));
  });
  const end = performance.now();
  const duration = Math.round(end - start);

  if(found.length === 0){
    results.innerHTML = `<div class="no-results">Keine Ergebnisse gefunden für: <strong>${term}</strong></div>`;
    return;
  }

  const h2 = document.createElement("h2");
  h2.textContent = "Ergebnisse";
  results.appendChild(h2);

  const info = document.createElement("div");
  info.style.fontSize = "0.9rem";
  info.style.color = "#666";
  info.style.marginBottom = "0.6rem";
  info.textContent = `${found.length} Ergebnisse gefunden in ${duration} ms`;
  results.appendChild(info);

  found.forEach((e,i) => {
    const item = document.createElement("div");
    item.className = "result-item";

    const titleWrap = document.createElement("div");
    titleWrap.style.fontWeight = "700";
    const a = document.createElement("a");
    const titleHtml = highlightHtml(e.title || "Ohne Titel", words);
    a.innerHTML = titleHtml;
    a.href = e.url || "#";
    if(a.href.startsWith("http") && !a.href.includes(location.hostname)){ 
      a.target = "_blank"; a.rel = "noopener"; 
    }
    titleWrap.appendChild(a);

    const desc = document.createElement("div");
    desc.innerHTML = `<small>${highlightHtml(e.desc || "", words)}</small>`;

    item.appendChild(titleWrap);
    item.appendChild(desc);
    results.appendChild(item);

    if(i < found.length - 1) {
      const hr = document.createElement("hr");
      hr.className = "result-sep";
      results.appendChild(hr);
    }
  });
}

function doSearch(){
  const term = input.value.trim();
  if(!isValidQuery(term)){ 
    results.innerHTML = ""; 
    if(location.search) history.replaceState(null, "", location.pathname); 
    return; 
  }
  const newQ = "?q=" + encodeURIComponent(term);
  if(location.search !== newQ) history.replaceState(null, "", newQ);
  runSearch(term);
  saveHistory(term);
  renderSuggestions(false);
}

  searchBtn.addEventListener("click", doSearch);
  input.addEventListener("keydown", (e) => { if(e.key === "Enter"){ e.preventDefault(); doSearch(); } });

  window.addEventListener("popstate", () => {
    const q = new URLSearchParams(location.search).get("q") || "";
    input.value = q;
    if(q) runSearch(q); else results.innerHTML = "";
  });

  (function init(){
    const q = new URLSearchParams(location.search).get("q") || "";
    if(q){ input.value = q; runSearch(q); }
    renderSuggestions(false);
    loadAllData();
  })();
</script>
</body>
</html>
