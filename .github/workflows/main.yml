name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  preflight:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - run: |
          set -e
          repo="$GITHUB_REPOSITORY"
          run_id=$GITHUB_RUN_ID
          cur_created=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$repo/actions/runs/$run_id" | jq -r .created_at)
          while true; do
            others=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$repo/actions/runs?status=in_progress&per_page=100" | jq --argjson rid "$run_id" --arg cur "$cur_created" '[.workflow_runs[] | select(.id != $rid and (.created_at < $cur)) | {id:.id,name:.name,status:.status,html_url:.html_url}]')
            queued=$(curl -s -H "Authorization: token $GITHUB_TOKEN" "https://api.github.com/repos/$repo/actions/runs?status=queued&per_page=100" | jq --argjson rid "$run_id" --arg cur "$cur_created" '[.workflow_runs[] | select(.id != $rid and (.created_at < $cur)) | {id:.id,name:.name,status:.status,html_url:.html_url}]')
            combined=$(jq -n --argjson a "$others" --argjson b "$queued" '$a + $b')
            if [ "$(echo "$combined" | jq 'length')" -eq 0 ]; then
              break
            fi
            echo "$combined" | jq -r '.[] | "\(.name) (\(.id)) - \(.status) - \(.html_url)"'
            sleep 30
          done

  build:
    runs-on: ubuntu-latest
    needs: preflight
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "18"
      - run: npm ci
      - run: npm run build
      - uses: actions/upload-pages-artifact@v1
        with:
          path: ./public

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/configure-pages@v3
      - uses: actions/deploy-pages@v1
